package org.androidpn.demoapp;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.StreamCorruptedException;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.TimeZone;

import org.androidpn.client.Constants;
import org.androidpn.client.XmppManager;
import org.androidpn.server.model.User;
import org.androidpn.util.GetPostUtil;
import org.androidpn.util.UserUtil;
import org.androidpn.util.Xmler;

import android.app.Activity;
import android.app.AlertDialog;
import android.app.Dialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.DialogInterface.OnClickListener;
import android.content.Intent;
import android.graphics.BitmapFactory;
import android.graphics.Color;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.Drawable;
import android.os.AsyncTask;
import android.os.Bundle;
import android.text.Layout;
import android.text.format.DateFormat;
import android.text.format.Time;
import android.util.Log;
import android.util.Pair;
import android.util.TimeUtils;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.View;
import android.view.ViewGroup;
import android.view.WindowManager.LayoutParams;
import android.widget.ArrayAdapter;
import android.widget.BaseAdapter;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.PopupWindow;
import android.widget.TextView;
import android.widget.Toast;

import java.util.List;

import org.jivesoftware.smack.PacketListener;
import org.jivesoftware.smack.Roster;
import org.jivesoftware.smack.RosterEntry;
import org.jivesoftware.smack.XMPPConnection;
import org.jivesoftware.smack.filter.PacketFilter;
import org.jivesoftware.smack.packet.IQ;
import org.jivesoftware.smack.packet.Message;
import org.jivesoftware.smack.packet.Packet;
import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserException;
import org.xmlpull.v1.XmlPullParserFactory;

import android.os.Handler;
import android.widget.EditText;

public class ChatActivity extends Activity {
	private String LOGTAG = "chatActivity";
	List<ChatInfo> messages;
	private String USERNAME;
	private String PASSWORD;
	private String recipient = "";// who you are talking with
//	private Handler mHandler = new Handler();
	private EditText mTextMessage;
	private ListView mListView;
	private List<User> friendList;
	private XmppManager xmppManager;
	private MyAdapter mAdapter;
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_chat);
		Log.i(LOGTAG, "hello i am oncreate");
		USERNAME = getIntent().getStringExtra("userID");
		PASSWORD = getIntent().getStringExtra("Pwd");// used for 8080 connection

		xmppManager = Constants.xmppManager;// if it is null, this will be a
											// trouble
		packetList=Constants.packetList;
		if(packetList==null)
			packetList = Constants.packetList=new ArrayList<Pair>();
		
		friendList=Constants.friendList;
		if(friendList==null)
			getFriend();

		// messages stores the talk contents with friends
		messages = new ArrayList<ChatInfo>();
		
		// ArrayAdapter<String>(this,android.R.layout.simple_list_item_1,messages);
		mAdapter = new MyAdapter(this, messages);
		mListView = (ListView) this.findViewById(R.id.MessageListView);
		mListView.setAdapter(mAdapter);
		addMsgView(new ChatInfo("test", "helloworld", new Date(),true));
		
		// chatUri=getString(R.string.androidpnserver+"/send.xml?"); this is too slow for chat
		mTextMessage = (EditText) this.findViewById(R.id.MessageEdit);

		friendList = new ArrayList<User>();

		smThread = new SendMsgThread(xmppManager);
		smThread.start();
 		
		Button findBtn = (Button) this.findViewById(R.id.FindUserBtn);
		findBtn.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View arg0) {
				alertFindUserForm();
			}
		});
		// go back home button
		Button homeBtn = (Button) this.findViewById(R.id.HomeBtn);
		homeBtn.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				Intent intent = new Intent(ChatActivity.this,
						DemoAppActivity.class);
				startActivity(intent);
			}
		});
		Button contactsBtn=(Button) this.findViewById(R.id.FriendListBtn);
		contactsBtn.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View v) {
				// TODO Auto-generated method stub
				Intent intent=new Intent(ChatActivity.this,ContactActivity.class);
				intent.putExtras(ChatActivity.this.getIntent().getExtras());
				startActivity(intent);
			}
		});
		// send message button
		// Set a listener to send a chat text message
		Button sendBtn = (Button) this.findViewById(R.id.SendBtn);
		sendBtn.setOnClickListener(new View.OnClickListener() {
			public void onClick(View view) {
				String to = recipient;
				if (to == null) {// 先发送给自己　做测试
					to = "abc";
				}
				String text = mTextMessage.getText().toString();
				Log.i(LOGTAG,
						"XMPPChatActivity#send.onclicklistener Sending text "
								+ text + " to " + to);
				Message msg = new Message("abc", Message.Type.chat);
				msg.setBody(text);
				if (xmppManager == null) {
					Log.i(LOGTAG,
							"XMPPChatActivity#send.onclicklistener xmppmanager is null");
					return;
				} else {
					// 显示出来
					//messages.add
					ChatActivity.this.addMsgView(new ChatInfo
							(USERNAME, msg.getBody(),new Date(System.currentTimeMillis()),true));
					addMsg(msg);
				}
				mTextMessage.setText("");
			}
		});
		xmppManager.addPacketListener(new PacketListener() {
			@Override
			public void processPacket(Packet packet) {
				// TODO Auto-generated method stub
				if (packet instanceof Message) {
					// 显示接收到的消息
					String jid= packet.getFrom();
					String username =jid.substring(0,jid.indexOf('@'));
					Log.i(LOGTAG,"recv packet from:"+username);
					ChatActivity.this.addMsgView(new ChatInfo
							(username, ((Message) packet).getBody(), new Date(),false));
				} else if (packet instanceof IQ) {
					if (((IQ) packet).getType() == IQ.Type.RESULT) {
						if (((IQ) packet).getError() == null) {
							// 发送的消息成功被服务器接收
							Log.i(LOGTAG, "recv a result IQ whose id is :"
									+ packet.getPacketID());
						}
					}
				}
			}
		}, new PacketFilter() {
			@Override
			public boolean accept(Packet packet) {
				// TODO Auto-generated method stub
				return packet.getPacketID() != null;
			}
		});
		//new InitTask().run();
	}
	
	private void addMsgView(ChatInfo ci){
		Log.i(LOGTAG,"add Msg view "+ci.getContent());
		messages.add(ci);
		mAdapter.notifyDataSetChanged(); 
	}
	
	/*
	 * related to chat list
	 */
	private class ChatInfo {
		String username;
		String chatXml;
		Date time;
		boolean isSelf;

		public ChatInfo(String u, String chat, Date time, boolean isSelf) {
			this.username = u;
			this.chatXml = chat;
			this.time = time;
			this.isSelf=isSelf;
		}

		public Date getTime() {
			return time;
		}

		public String getContent() {
			return chatXml;
		}

		public String getName() {
			return username;
		}
		public boolean isSelf(){
			return isSelf;
		}
	}

	private class MyAdapter extends BaseAdapter {
		List al;
		Context c;

		public MyAdapter(Context c, List al) {
			this.al = al;
			this.c = c;
		}

		@Override
		public int getCount() {
			// TODO Auto-generated method stub
			return al.size();
		}

		@Override
		public Object getItem(int position) {
			// TODO Auto-generated method stub
			return (ChatInfo) al.get(position);
		}

		@Override
		public long getItemId(int position) {

			return position;
		}

		@Override
		public View getView(int position, View convertView, ViewGroup parent) {
			View v = null;
			LayoutInflater li = LayoutInflater.from(c); 
			//li=(LayoutInflater) c.getSystemService(Context.LAYOUT_INFLATER_SERVICE);  li.inflate(itemLayout, layout, true); 
			if(((ChatInfo)al.get(position)).isSelf()){
				v = li.inflate(R.layout.left_chat_list, null);
			} else 
				v= li.inflate(R.layout.right_chat_list, null);
			Date dt=((ChatInfo) al.get(position)).getTime();
			((TextView) v.findViewById(R.id.tvtime))
					.setText(DateFormat.format("MM-dd hh:mm:ss",dt.getTime()));//%Y-%m-%d %H:%M:%S %W-%A    %A %H:%M:%S
			ChatInfo ci=(ChatInfo) al.get(position);
			((ImageView)v.findViewById(R.id.ivicon)).setBackgroundDrawable(
					getResources().getDrawable(UserUtil.getPhoto(ci.getName())));
			((TextView) v.findViewById(R.id.tvname)).setText(((ChatInfo) al
					.get(position)).getName());
			((TextView) v.findViewById(R.id.tvcontent)).setText(((ChatInfo) al
					.get(position)).getContent());
			return v;
		}
	}

	
	
	/*
	 * related to find and add friend
	 */
	private void findUser(String s) {
		String androidpnURL = getString(R.string.androidpnserver);
		StringBuilder parameter = new StringBuilder();
		parameter.append("action=getUser"); //
		parameter.append("&username=" + s);
		/*--End--*/
		String resp = GetPostUtil.send("POST", androidpnURL + "user.xml",
				parameter);
		if (resp != null) {
			resp = resp.substring(resp.indexOf("\n") + 1);
			resp = resp.replaceAll("\n", "");
			int i = resp.indexOf("<user>"), j;
			if (i < 0 || (j = resp.indexOf("</user>")) < 0) {
				alert("未找到相应用户");
				Log.i(LOGTAG, "USER NOT FOUND");
				return;
			} else {
				String str = resp.substring(i, j + 7);
				Log.i(LOGTAG, "user :" + str);
				Xmler.getInstance().alias("user", User.class);
				User u = (User) Xmler.getInstance().fromXML(str);

				if (u == null) {
					Log.i(LOGTAG, "user not valid");
					alert("用户无效");
					return;
				}
				Log.i(LOGTAG, "USER FOUND:" + u.getName());
				displayUser(u);
			}
		}
	}
	private String getXmlElement(String resp,String tag){
		if(resp==null||tag==null) return null;
		int i = resp.indexOf("<"+tag+">"), j;
		if (i < 0 || (j = resp.indexOf("</"+tag+">")) < 0) {
			return null;
		}
		return resp.substring(i+tag.length()+2,j);
	}
	
	private void displayUser(final User u) {
		LayoutInflater inflater = (LayoutInflater) this
				.getSystemService(LAYOUT_INFLATER_SERVICE);
		// 这里的main布局是在inflate中加入的哦，以前都是直接this.setContentView()的吧？呵呵
		// 该方法返回的是一个View的对象，是布局中的根
		View layout = inflater.inflate(R.layout.user_info, null);
		Log.i(LOGTAG,"display user:"+Xmler.getInstance().toXML(u));
		((TextView) layout.findViewById(R.id.UsernameLabel)).setText(u.getName());
		((TextView) layout.findViewById(R.id.UserIDLabel)).setText(u.getId()+"");
		((TextView) layout.findViewById(R.id.UserEmailLabel)).setText(u.getEmail());
		((ImageView) layout.findViewById(R.id.UserPhotoLabel)).setImageDrawable(
				getResources().getDrawable(UserUtil.getPhoto(u.getName())));
		TextView foLink = (TextView) layout.findViewById(R.id.ChatWithBtn);
		foLink.setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				Intent intent=new Intent(ChatActivity.this,ChatActivity.class);
				Bundle bundle=ChatActivity.this.getIntent().getExtras();
				bundle.putString("recipient", u.getName());
				intent.putExtras(bundle);
//				bundle.putString("userID",USERNAME);
//				bundle.putString("Pwd", PASSWORD);
				startActivity(intent);
				Log.i(LOGTAG, "FRIEND ADDED");
			}
		});
		new AlertDialog.Builder(ChatActivity.this).setView(layout)
			.setPositiveButton("添加关注", new DialogInterface.OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					// TODO Auto-generated method stub
					final String s=u.getId()+"";
					addFriend(s);
				}
			}).setNegativeButton("退出", new DialogInterface.OnClickListener() {
				@Override
				public void onClick(DialogInterface dialog, int which) {
					// TODO Auto-generated method stub
				}
			}).show();
		
//		PopupWindow uWindow = new PopupWindow(layout, 200, 100);// LayoutParams.FILL_PARENT,
//																// LayoutParams.WRAP_CONTENT);
//																// //后两个参数是width和height
//		uWindow.setBackgroundDrawable(new BitmapDrawable());
//		uWindow.setFocusable(true);
//		uWindow.setOutsideTouchable(false);
//		uWindow.showAtLocation(inflater.inflate(R.layout.activity_chat, null),
//				1, 0, 0);
	}
	/*
	 * related to alert a message window on the screen
	 */
	private void alertFindUserForm() {
		LayoutInflater inflater = (LayoutInflater) this
				.getSystemService(LAYOUT_INFLATER_SERVICE);
		final View layout = inflater.inflate(R.layout.user_info_alert, null);
		AlertDialog dlg = new AlertDialog.Builder(ChatActivity.this).setView(layout)
				.setPositiveButton("确定",new DialogInterface.OnClickListener() {
			public void onClick(DialogInterface arg0, int arg1) {
				// TODO Auto-generated method stub
				EditText et=(EditText)layout.findViewById(R.id.FindUserEdit);
				findUser(et.getText().toString());
			}
		}).setNegativeButton("取消",new DialogInterface.OnClickListener(){
			public void onClick(DialogInterface arg0, int arg1){
			}
		}).show();
	}
	//add friend in a asynchronous way
	private void addFriend(final String userId){
		new Runnable(){
			public void run(){
				String androidpnURL = getString(R.string.androidpnserver);
				String params="action=addFriend&id2="+userId+"&username1="+USERNAME;
				String res=GetPostUtil.sendPost(androidpnURL+
						"user.xml",params);
				Log.i(LOGTAG,"addfriend.onclick:"+res);
				String status=getXmlElement(res,"status");
				String reason=getXmlElement(res,"reason");
				if(status==null){
					alert("添加失败:"+(reason==null?"":reason));
				}
				else if(status=="1"){
					alert("添加关注成功");
				}else{
					alert("你们已经是好友了");
				}
			}
		}.run();
	}
	private void getFriend(){
		new Runnable(){
			public void run(){
				String androidpnURL = getString(R.string.androidpnserver);
				String params="action=listFriend&username="+USERNAME;
				String resp=GetPostUtil.sendPost(androidpnURL+
						"user.xml",params);
				if("succeed".equals(getXmlElement(resp,"result"))){
					alert(resp);
					int i = resp.indexOf("<list>"), j;
					if (i < 0 || (j = resp.indexOf("</list>")) < 0) {
						alert("未找到相应用户");
						Log.i(LOGTAG, "USER NOT FOUND");
						return;
					} else {
						String str = resp.substring(i, j + 7);
						Log.i(LOGTAG, "list :" + str);
						Xmler.getInstance().alias("user", User.class);
						List<User> list = (List) Xmler.getInstance().fromXML(str);

						if (list == null) {
							Log.i(LOGTAG, "friendlist invalid");
							alert("没有找到好友");
							return;
						}
						friendList=Constants.friendList=list;
						alert("通讯录已经同步");
					}
				}else{
					String reason=getXmlElement(resp,"reason");
					alert("拉取好友列表失败:"+(reason==null?"":reason));
				}
			}
		}.run();
	}
	
	
	
	public void alert(String s){
		new AlertDialog.Builder(this).setIcon(
	     android.R.drawable.ic_dialog_info).setTitle("结果").setMessage(
	     s).setPositiveButton("确定",
	     new OnClickListener() {
	      @Override
	      public void onClick(DialogInterface dialog, int which) {
	       // TODO Auto-generated method stub
	      }
	      }).show();

	}

	/**
	 * related to send message thread always try to send packets to server if
	 * packet in packetList
	 */
	private List<Pair> packetList;
	private SendMsgThread smThread;

	@SuppressWarnings("unchecked")
	public void addMsg(Packet msg) {
		synchronized (packetList) {
			packetList.add(new Pair(msg,false));
		}
	}

	@SuppressWarnings("unused")
	private class SendMsgThread extends Thread {
		final XmppManager xmppManager;

		private SendMsgThread(XmppManager manager) {
			xmppManager = manager;
		}

		public void run() {
			Log.i(LOGTAG, "chatactivity#SendMsgTask#run()... ");
			XMPPConnection conn = null;
			Packet packet = null;
			while (true) {
				// since this thread is only reading the packetlist, no need to
				// synchronized
				// synchronized(packetList){
				if (packetList.isEmpty()) {
					try {
						Thread.currentThread();
						Thread.sleep(200);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					continue;
				}
				synchronized (packetList) {
					packet = (Packet) packetList.get(0).first;
				}
				// packetList.remove(0);　//we may not need to remove it now, we
				// can remove when it's sent
				Log.i(LOGTAG, "XmppManager#sendMsgTask packet in sending:"
						+ packet.toXML());
				xmppManager.sendMsg(packet);

				Log.i(LOGTAG,
						"XmppManager#sendMsgTask waiting for packet to be sent");
				Log.i(LOGTAG, "XmppManager#sendMsgTask !!!!packet sent");
				synchronized (packetList) {
					packetList.remove(0);
				}
			}
		}

	}

	/*
	 * related to get roster(friend list) thread
	 */
	public class InitTask implements Runnable {

		@Override
		public void run() {
			// TODO Auto-generated method stub
			Log.i(LOGTAG, "init task running");
			Roster rost = xmppManager.getConnection().getRoster();
			if (rost == null) {
				Log.d(LOGTAG, "roster null");
				return;
			}
			Log.i(LOGTAG, "roster:" + rost.toString());
			Collection<RosterEntry> entries = rost.getEntries();
			for (RosterEntry entry : entries) {
				User u = new User();
				u.setUsername(entry.getUser());
				Log.i(LOGTAG, "roster item:" + entry.getUser());
				friendList.add(new User());
			}
			Log.i(LOGTAG, "init task finished");
		}
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		// Inflate the menu; this adds items to the action bar if it is present.
		getMenuInflater().inflate(R.menu.chat, menu);
		return true;
	}

}
